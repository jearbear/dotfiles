#
# OPTIONS
#

set-option global startup_info_version 20250603
set-option global scrolloff 100,100
set-option global autoreload true
set-option global ui_options terminal_enable_mouse=false terminal_assistant=none terminal_set_title=false terminal_status_on_top=false

set-option global grepcmd 'rg --column --smart-case --sort path'

add-highlighter global/ wrap -indent -marker ...
add-highlighter global/ show-matching -previous
add-highlighter global/ show-whitespaces -lf ' ' -spc ' ' -nbsp ' ' -indent '▏'
#
set-option global modelinefmt '%val{bufname} {{context_info}} {{mode_info}} '

# I save frequently and this slows down startup
autorestore-disable


#
# COMMANDS
#

define-command pick-buffer -docstring 'fuzzy find a buffer' %{
    prompt -buffer-completion 'buffer:' %{ buffer %val{text} }
}

define-command dbg -docstring 'open debug buffer' %{
    evaluate-commands 'buffer *debug*'
}

define-command update -docstring 'save file if modified' %{
    evaluate-commands %sh{
        if [ "$kak_modified" = "true" ]; then
            printf "write"
        fi
    }
}

define-command new-window -docstring 'open file in new window' %{
    evaluate-commands "new edit %val{buffile} %val{cursor_line}"
}

#
# MAPPINGS
#

map global user w :w<ret>                                     -docstring "save file" 
map global user q :q<ret>                                     -docstring "quit" 
map global user x :wq<ret>                                    -docstring "save + quit" 
map global user / :comment-line<ret>                          -docstring "comment line(s)" 
map global user f ":kitty-script-launch fzf-file<ret>"        -docstring "pick file" 
map global user F ":kitty-script-launch fzf-git-file<ret>"    -docstring "pick changed file" 
map global user b ":pick-buffer<ret>"                         -docstring "pick buffer" 
map global user n ":new-window<ret>"                          -docstring "open new window" 
map global user * '*%s<ret>'                                  -docstring "select all"

# Insert lines above/below
# map global normal <ret> <a-o>
# map global normal <s-ret> <a-O>

# Readline mappings
map global insert <c-a> <home>
map global insert <c-e> <end>
map global insert <c-f> <right>
map global insert <c-b> <left>
map global insert <c-d> <del>
map global insert <c-h> <backspace>
map global insert <c-k> '<a-;>;<a-;>Gl<a-;>"_d'
map global insert <c-u> '<a-;>;<a-;>h<a-;>Gh<a-;>"_d'
map global insert <c-w> '<a-;>b<a-;>"_d'

# Faster scrolling
map global normal <c-d> 5j
map global normal <c-u> 5k

# Redo like vim
map global normal <c-r> <s-u>

# Goto beginning of line like vim
# map global normal 0 'gi'

# Indent in insert mode
map global insert <c-,> '<a-;><'
map global insert <c-.> '<a-;>>'

# Make history navigation harder to trigger on accident
map global normal <c-j> ''
map global normal <c-k> ''
map global normal <c-s-j> <c-j>
map global normal <c-s-k> <c-k>

# Edit config files quickly
map global user C ':edit ~/.config/kak/kakrc<ret>' -docstring 'edit kakrc'

# Faster grep
map global normal <\> ':kitty-script-launch fzf-rg<ret>'

# I always want to insert where the cursor is, not where the selection is
map global normal i ';i'

# Make it easier to exit a multi-cursor situation
map global normal <esc> ';,<esc>'

# I never want whitespace included when I do this
map global normal * '_*'

# Better mappings for object selection
map global normal v '<a-i>'
map global normal V '<a-a>'

# Navigate selection history
map global normal <c-.> '<a-.>'
map global normal <c-9> '<a-u>'
map global normal <c-0> '<a-U>'

# Case insensitive search
map global normal / '/(?i)'

# File manager
map global normal <minus> ':kitty-script-launch nnn<ret>'

# Additional objects
define-command select-line -hidden %{
    execute-keys %sh{
        case $kak_object_flags in
            *inner*)
                printf 'x_'
                ;;
            *)
                printf 'x'
                ;;
        esac
    }
}
map global object l '<a-;>select-line<ret>'      -docstring 'line'
map global object L '<a-;>select-line<ret>'      -docstring 'line'
map global object f 'c\w+\(,\)<ret>'             -docstring 'function'

# Better repeat mappings
# map global normal ; '<a-.>'
#



#
# HOOKS
#

hook global FocusOut .* 'update'

# Change cursor color depending on the mode
hook global ModeChange push:.*:insert %{
    set-face window CursorLine CursorLineInsertMode
}
hook global ModeChange pop:insert:.* %{
    unset-face window CursorLine
}

# Highlight current line
define-command update-cursor-line %{
    evaluate-commands %{
        try %{ remove-highlighter window/cursor-line }
        try %{ add-highlighter window/cursor-line line %val{cursor_line} CursorLine }
    }
}
hook global NormalIdle .* "update-cursor-line"
hook global RawKey .+ "update-cursor-line"

# Enable auto-formatting if format command is enabled
hook global BufSetOption formatcmd=.+ %{
    hook buffer BufWritePre .* format
}


#
# PLUGINS
#

# Smart tab
# Always use spaces for indentation
hook global BufOpenFile .* expandtab
hook global BufNewFile .* expandtab
# Default indentation
hook global ModuleLoaded smarttab %{
    set-option global indentwidth 4

    # Sync softtabstop with the indent width
    hook global BufSetOption indentwidth=(.*) %{
        set-option buffer softtabstop %val{hook_param_capture_1}
    }
}

# Git
declare-user-mode git
map global user g ":enter-user-mode git<ret>"   -docstring "git"
map global git p ":git prev-hunk<ret>"          -docstring "prev git hunk"
map global git n ":git next-hunk<ret>"          -docstring "next git hunk"
map global git u ":git apply --reverse<ret>"    -docstring "undo hunk"
map global git b ":git-blame-line<ret>"         -docstring "blame line"
map global git B ":git-blame-line-open-pr<ret>" -docstring "open PR for this line"
map global git o ":git-open-line<ret>"          -docstring "open file in browser"

map global goto p "<esc>:git prev-hunk<ret>" -docstring "prev git hunk"
map global goto n "<esc>:git next-hunk<ret>" -docstring "next git hunk"

set-option global git_diff_add_char '▍\ '
set-option global git_diff_mod_char '▍\ '

add-highlighter global/git-diff flag-lines Default git_diff_flags

hook global -group git-gutter-hooks NormalIdle .* %{
  try %{ git-async update-diff }
}

# Treesitter
# Currently too slow on large files
# evaluate-commands %sh{ kak-tree-sitter -dks -vvvvv --init $kak_session }


#
# LSP
#

eval %sh{kak-lsp}
lsp-enable
# set global lsp_debug true

# Disable default servers
remove-hooks global lsp-filetype-.*

set-option global lsp_diagnostic_line_error_sign "● "
set-option global lsp_diagnostic_line_warning_sign "● "
set-option global lsp_diagnostic_line_info_sign "● "
set-option global lsp_diagnostic_line_hint_sign "● "

lsp-inlay-diagnostics-enable global

hook global BufSetOption lsp_servers=.+ %{
    map global user l ':enter-user-mode lsp<ret>' -docstring "lsp"
    # Override whatever the LSP does to the modeline
    set-option global modelinefmt '%val{bufname} {{context_info}} {{mode_info}} '

    map global normal <c-j> ':lsp-find-error --include-warnings<ret>'
    map global normal <c-k> ':lsp-find-error --include-warnings --previous<ret>'
}

define-command lsp-enable-semantic-tokens -params 1 %{
    hook global WinSetOption filetype=%arg{1} %{
        hook window -group semantic-tokens BufReload .* lsp-semantic-tokens
        hook window -group semantic-tokens NormalIdle .* lsp-semantic-tokens
        hook window -group semantic-tokens InsertIdle .* lsp-semantic-tokens
        hook -once -always window WinSetOption filetype=.* %{
            remove-hooks window semantic-tokens
        }
    }
}

# Enable auto-formatting if LSP is enabled
declare-option bool lsp_format false
hook global BufSetOption lsp_format=true %{
    hook buffer BufWritePre .* lsp-formatting-sync
}


hook global BufSetOption filetype=python %{
    set-option buffer lsp_servers %{
        [basedpyright-langserver]
        root_globs = [".git"]
        args = ["--stdio"]
        settings_section = "_"

        [basedpyright-langserver.settings._.basedpyright]
        disableOrganizeImports = true
        analysis.typeCheckingMode = "off"
        analysis.ignore = ["*"]

        [ruff]
        root_globs = [".git"]
        args = ["server"]
    }

    set-option buffer lsp_format true
    set-option buffer indentwidth 4

    require-module python
    add-highlighter shared/python/code/ regex ([A-Z]+[a-z0-9]+)+ 0:class
    add-highlighter shared/python/code/ regex (self) "0:%opt{color_peach}"
    add-highlighter shared/python/code/ regex (True|False|None) "0:%opt{color_peach}"
    add-highlighter shared/python/code/ regex (@[a-zA-Z\._]+) "0:%opt{color_peach}"
    add-highlighter shared/python/code/ regex ([\(\)\[\]\{\}]) "0:%opt{color_pink}"
    add-highlighter shared/python/code/ regex ([\.,]) 0:comment
    add-highlighter shared/python/code/ regex "def ([a-zA_Z_]+)\(" 1:function

    lsp-enable-semantic-tokens python
}

hook global BufSetOption filetype=typescript %{
    set-option buffer lsp_servers %{
        [typescript-language-server]
        root_globs = [".git"]
        args = ["--stdio"]
    }

    set-option buffer lsp_format true
    set-option buffer indentwidth 2
}

hook global BufSetOption filetype=nix %{
    set-option buffer lsp_servers %{
        [nil]
        root_globs = ["flake.nix", "shell.nix", ".git", ".hg"]
    }

    set-option buffer lsp_format true
    set-option buffer indentwidth 2
}

hook global BufSetOption filetype=(elixir|eex) %{
    set-option buffer lsp_servers %{
        [elixir-ls]
        root_globs = ["mix.exs"]
        settings_section = "_"

        # https://github.com/elixir-lsp/elixir-ls?tab=readme-ov-file#elixirls-configuration-settings
        [elixir-ls.settings._.elixirLS]
        dialyzerEnabled = false
        incrementalDialyzer = false
    }

    set-option buffer lsp_format true
    set-option buffer indentwidth 2
}

hook global BufSetOption filetype=markdown %{
    set-option buffer indentwidth 2
}

hook global BufSetOption filetype=grep %{
    map window normal <ret> <ret>
    map window normal <s-ret> <s-ret>
}

hook global BufSetOption filetype=sh %{
    set-option buffer formatcmd "shfmt --indent %opt{indentwidth} --space-redirects"
}

#
# OS-SPECIFIC
#
try %sh{
    if [ "$(uname)" = Darwin ]; then
        printf "source $kak_config/osx.kak"
    else
        printf "source $kak_config/linux.kak"
    fi
}



colorscheme catppuccin
