#!/bin/bash

set -euo pipefail

usage() {
    cat <<EOF

Dotfile management made less toilesome.

Usage:
    dotit help                 Display this help message.
    dotit add <dotfile>        Link <dotfile> to home directory.
    dotit list                 List all installed linked dotfiles in the current directory.

EOF
}

while [[ $# -gt 0 ]]; do
    subcommand=$1
    shift

    case $subcommand in
        add)
            dotfile=$1

            if [ -z "$dotfile" ]; then
                echo "Error: must provide a dotfile to link."
                exit 1
            fi

            if [ ! -e "$dotfile" ]; then
                echo "Error: dotfile \"$dotfile\" doesn't exist."
                exit 1
            fi

            echo "Linking: $PWD/$dotfile -> $HOME/.$dotfile"
            ln -sf "$PWD/$dotfile" "$HOME/.$dotfile"

            shift
            ;;

        list)
            find -- * -type f | while read -r dotfile; do
		if [ "$(greadlink -f "$HOME/.$dotfile")" == "$PWD/$dotfile" ]; then
                    echo "- $dotfile"
		fi
            done

	    shift
            ;;

	*)
            usage
            exit

	    shift
            ;;
esac
done

usage
